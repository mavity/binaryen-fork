# Team Libs Plan — Phase 1 (Utilities)

Short summary:
- Goal: Convert low-level, leaf components (string interner, arena allocators, fast hash maps) to Rust and provide stable FFI wrappers so other teams can consume them.
- See the master plan [Phase 1](../vision/RUST_CONVERSION_PLAN.md#phase-1-utility-components) and the checklists: [Phase 1 checklists](../vision/rust-conversion-checklists.md#phase-1-utility-components).

## Objectives
- Implement `binaryen-support` with a set of core utilities, starting with a string interner.
- Provide FFI wrappers for basic utilities in `binaryen-ffi` so existing C++ code can call them.
- Add robust unit tests, property tests, and benchmarks for each utility.

## Tasks
- [x] Convert `string` utilities (See `rust/binaryen-support/src/strings.rs` for an initial implementation). ✅ Implemented
  - Implement `StringInterner` and add unit tests and proptest-based fuzz for edge cases (`rust/binaryen-support/src/strings.rs`, `fuzz/fuzz_targets/interner.rs`).
  - Add FFI functions in `rust/binaryen-ffi`:
    - `BinaryenStringInternerCreate`/`Dispose`/`Intern` implemented in `rust/binaryen-ffi/src/lib.rs` and covered in `rust/binaryen-ffi` tests and `test/rust_consumer/test_ffi.c`.
  - Ensure ABI stability: add `cbindgen` checks after API is agreed (see `rust/scripts/check_cbindgen.sh`).

- [x] Implement arena allocation utilities (using `bumpalo` or `bumpalo`-backed crates) — implemented; API/ownership doc pending.
  - Add `Arena` type with allocation helpers in `binaryen-support` (`rust/binaryen-support/src/arena.rs`).
  - Add FFI-safe functions to allocate/free arenas or provide opaque handles (`BinaryenArenaCreate/Dispose/AllocString`), implemented in `rust/binaryen-ffi/src/lib.rs`.
  - Note: Document ownership semantics in `docs/rust/vision/rust-conversion-technical-specs.md#memory-management` or a dedicated `docs/rust/vision/arena-ownership.md` — this remains to be finalized.

- [x] Add `hash` utilities and fast hashing with `ahash`.
  - Implement wrappers for `AHashMap` and helper functions in `rust/binaryen-support/src/hash.rs`.
  - Add `ahash_bytes` helper and `BinaryenAhashBytes` FFI helper in `rust/binaryen-ffi/src/lib.rs`.
  - Add `FastHashMap` FFI wrapper for `String -> uint64` via `BinaryenFastHashMap*` handlers and tests.

- [x] Add benchmarks using `criterion` and property tests using `proptest`.
  - Create `bench/` in `rust/binaryen-support` (`benches/bench_support.rs`).
  - Add CI benchmark job (nightly) to catch regressions (`.github/workflows/rust-bench-nightly.yml` exists).

 - [ ] Add code examples and API documentation in `docs/rust`.
  - Status: Partial. The technical-specs and getting-started pages exist; crate-level `README.md` files (`rust/binaryen-support/README.md`, `rust/binaryen-ffi/README.md`) have been added but more short C++ examples and long-form API docs are still needed.
  - Action: Added `docs/rust/vision/ffi-reference.md` and `docs/rust/vision/arena-ownership.md`.
  - Status: Partial. The technical-specs and getting-started pages exist; crate-level `README.md` files (`rust/binaryen-support/README.md`, `rust/binaryen-ffi/README.md`) have been added but more short C++ examples and long-form API docs are still needed.

- [x] Add `cargo-fuzz` harnesses for `interner`, `arena`, and `ahash` in `fuzz/`; a `workflow_dispatch` sample exists at `.github/workflows/rust-fuzz.yml` and `rust/scripts/run_cargo_fuzz.sh` is included.
  - Validation: local short runs completed; longer runs are available via `workflow_dispatch`.

## FFI contract & integration
- `rust/binaryen-ffi` now exposes a minimal API for the string interner.
  - See `include/binaryen_ffi.h` for the C header.
  - Use `cbindgen` with `rust/binaryen-ffi/cbindgen.toml` to generate headers; add golden checks in CI.
- Key rules for FFI:
  - Export opaque handles for Rust-owned values (e.g., `BinaryenStringInterner`).
  - Do not allocate or free across boundaries unless the FFI explicitly defines ownership semantics.
  - Use `#[repr(C)]` when exporting POD structs across FFI.

## CI / Test plan
- Add `cargo test --all` to the regular CI (already in progress).
- Add a `smoke-consumer` test that calls `BinaryenStringInterner` via header to validate memory ownership.
- Add nightly `cargo bench` to measure allocations and throughput.
- Add `cargo miri test` for UB checks on small, critical modules.

## Exit criteria
- `StringInterner` converts successfully with stable behavior.
- `Arena` API is designed and agreed upon; `Arena` tests pass.
- `binaryen-ffi` exposes at least `StringInterner` and passes the smoke test.

## Status snapshot & mapping (evidence)
- `StringInterner`: implemented in `rust/binaryen-support/src/strings.rs` with unit & proptest tests; FFI wrappers are in `rust/binaryen-ffi/src/lib.rs` and used in `test/rust_consumer/test_ffi.c`.
- `Arena`: implemented in `rust/binaryen-support/src/arena.rs`, with `BinaryenArenaCreate/Dispose/AllocString` wrappers in `rust/binaryen-ffi/src/lib.rs` and unit/property tests; `fuzz/fuzz_targets/arena.rs` exists.
- `FastHashMap`/`ahash`: implemented in `rust/binaryen-support/src/hash.rs`, with `BinaryenAhashBytes`/`BinaryenFastHashMap*` wrappers in `rust/binaryen-ffi/src/lib.rs` and tests.
- Smoke & cross-language tests: `test/rust_consumer` + CI `ctest -R rust_ffi_smoke` entries exercised in `.github/workflows/rust-ci.yml`.
 - Smoke & cross-language tests: `test/rust_consumer` + CI `ctest -R rust_ffi_smoke` entries exercised in `.github/workflows/rust-ci.yml`.
 - Extra cross-language tests added: `test/rust_consumer/test_ffi_threaded.cpp`, `test/rust_consumer/test_ffi_arena_threads.cpp`, and `test/rust_consumer/test_ffi_arena_misuse.cpp` (ctest targets `rust_ffi_smoke_threaded`, `rust_ffi_smoke_arena_threads`, `rust_ffi_smoke_arena_misuse`). These are also covered by `test/rust_consumer/build_and_run.sh`.

## Outstanding tasks and context (what we still need)
1. Finalize Arena API & ownership semantics (High priority)
  - The code is implemented but the FFI contract (lifetime & ownership of pointers returned by `Arena`) needs to be documented and reviewed. Add a dedicated doc (`docs/rust/vision/arena-ownership.md`) with do/don't examples and a checklist for reviewers.
2. Add crate-level README & examples (Medium priority)
  - `rust/binaryen-support/README.md` and `rust/binaryen-ffi/README.md` with how-to runs, examples, and `cbindgen` steps.
3. CI improvements & caching (Medium priority)
  - Add `BUILD_RUST_COMPONENTS=ON` matrix in workflows + `rust/target` caching to reduce job runtime.
4. ABI gating & PR policy (Medium priority)
  - Finalize docs for ABI gating & a PR checklist that enforces cbindgen golden update, ABI change sign-off, and `ctest rust_ffi_smoke` runs.
5. Cross-language tests for edge cases (Low-Medium priority)
  - Implemented: Added `test/rust_consumer/test_ffi_threaded.cpp` and `test/rust_consumer/test_ffi_arena_threads.cpp` to validate threaded interner/arena usage.
  - Still outstanding: Add more misuse tests and CI coverage for intentional misuse cases (if desired), and tests verifying thread safety of `Arena` if a thread-safe Arena API is introduced.

## Proposed next steps (work queue)
1. Add `README.md` files to `rust/binaryen-support/` and `rust/binaryen-ffi/` (Examples + tests + cbindgen update & check instructions).
2. Draft `docs/rust/vision/arena-ownership.md` with lifetime and pointer ownership rules; add example misuse tests and reviewer checklist.
3. Expand CI: add caching for `rust/target` and a platform matrix for `BUILD_RUST_COMPONENTS=ON` in `.github/workflows/rust-ci.yml` to increase coverage.
4. Add a cross-language test that validates an arena pointer used in another C++ thread remains valid, and one that intentionally misuses an arena pointer after `BinaryenArenaDispose` to ensure predictable behavior.
  - Action taken: Implemented `test_ffi_arena_use_after_dispose.cpp`, `test_ffi_arena_many_threads.cpp` and updated `test_ffi_arena_misuse.cpp` to be non-flaky when pointer reuse occurs.

## References
- Phase 1 plan: [RUST_CONVERSION_PLAN.md#phase-1-utility-components](../vision/RUST_CONVERSION_PLAN.md#phase-1-utility-components)
- Getting started & example: [rust-conversion-getting-started.md](../vision/rust-conversion-getting-started.md#first-component-string-interning)
- FFI patterns: [rust-conversion-technical-specs.md#ffi-patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- Checklists: [rust-conversion-checklists.md#phase-1-utility-components](../vision/rust-conversion-checklists.md#phase-1-utility-components)

---

This file can be used as a checklist and progress log for `Team Libs` as they implement functional utilities in Rust. Update as each task completes.
