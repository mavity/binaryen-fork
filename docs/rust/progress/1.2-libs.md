# Team Libs Plan â€” Phase 1 (Utilities)

Short summary:
- Goal: Convert low-level, leaf components (string interner, arena allocators, fast hash maps) to Rust and provide stable FFI wrappers so other teams can consume them.
- See the master plan [Phase 1](../vision/RUST_CONVERSION_PLAN.md#phase-1-utility-components) and the checklists: [Phase 1 checklists](../vision/rust-conversion-checklists.md#phase-1-utility-components).

## Objectives
- Implement `binaryen-support` with a set of core utilities, starting with a string interner.
- Provide FFI wrappers for basic utilities in `binaryen-ffi` so existing C++ code can call them.
- Add robust unit tests, property tests, and benchmarks for each utility.

## Tasks
- [ ] Convert `string` utilities (See `rust/binaryen-support/src/strings.rs` for an initial implementation).
  - Implement `StringInterner` and add unit tests and proptest-based fuzz for edge cases.
  - Add FFI functions in `rust/binaryen-ffi`:
    - `BinaryenStringInternerCreate`/`Dispose`/`Intern` implemented in `rust/binaryen-ffi/src/lib.rs`.
  - Ensure ABI stability: add `cbindgen` checks after API is agreed.

- [ ] Implement arena allocation utilities (using `bumpalo` or `bumpalo`-backed crates)
  - Add `Arena` type with allocation helpers in `binaryen-support`.
  - Document ownership semantics in `docs/rust/vision/rust-conversion-technical-specs.md#memory-management`.
  - Add FFI-safe functions to allocate/free arenas or provide opaque handles.

- [ ] Add `hash` utilities and fast hashing with `ahash`
  - Implement wrappers for `AHashMap` or helpers used in Binaryen.
  - Add benchmarks and tests to ensure performance parity with C++.

- [ ] Add benchmarks using `criterion` and property tests using `proptest`.
  - Create `bench/` or `benches/` in `rust/binaryen-support` to compare with C++ baselines.
  - Add CI benchmark job (nightly) to catch regressions.

- [ ] Add code examples and API documentation in `docs/rust`.
  - Add `docs/rust/progress/1.2-libs.md` (this file) and update `docs/rust/vision` with details.

## FFI contract & integration
- `rust/binaryen-ffi` now exposes a minimal API for the string interner.
  - See `include/binaryen_ffi.h` for the C header.
  - Use `cbindgen` with `rust/binaryen-ffi/cbindgen.toml` to generate headers; add golden checks in CI.
- Key rules for FFI:
  - Export opaque handles for Rust-owned values (e.g., `BinaryenStringInterner`).
  - Do not allocate or free across boundaries unless the FFI explicitly defines ownership semantics.
  - Use `#[repr(C)]` when exporting POD structs across FFI.

## CI / Test plan
- Add `cargo test --all` to the regular CI (already in progress).
- Add a `smoke-consumer` test that calls `BinaryenStringInterner` via header to validate memory ownership.
- Add nightly `cargo bench` to measure allocations and throughput.
- Add `cargo miri test` for UB checks on small, critical modules.

## Exit criteria
- `StringInterner` converts successfully with stable behavior.
- `Arena` API is designed and agreed upon; `Arena` tests pass.
- `binaryen-ffi` exposes at least `StringInterner` and passes the smoke test.

## References
- Phase 1 plan: [RUST_CONVERSION_PLAN.md#phase-1-utility-components](../vision/RUST_CONVERSION_PLAN.md#phase-1-utility-components)
- Getting started & example: [rust-conversion-getting-started.md](../vision/rust-conversion-getting-started.md#first-component-string-interning)
- FFI patterns: [rust-conversion-technical-specs.md#ffi-patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- Checklists: [rust-conversion-checklists.md#phase-1-utility-components](../vision/rust-conversion-checklists.md#phase-1-utility-components)

---

This file can be used as a checklist and progress log for `Team Libs` as they implement functional utilities in Rust. Update as each task completes.
