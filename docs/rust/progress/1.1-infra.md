# Team Infra Plan — Phase 0 (Infrastructure & FFI)

Short summary:
- Goal: Make Rust components buildable, testable, and ABI-safe from the C++ CMake pipeline while preserving the C++ baseline.
- See the master plan and checklists in:
  - ../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup
  - ../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup
  - ../vision/rust-conversion-technical-specs.md#ffi-patterns

## Objectives
- Cargo workspace + skeleton crates
- CMake integration + BUILD_RUST_COMPONENTS toggle
- cbindgen header generation + golden-check
- CI jobs for Rust unit tests, integration build, and ABI checks
- Small C++ smoke consumer examples and shim templates for teams to use

## Tasks (priority order)
- [ ] Create `rust/Cargo.toml` workspace (members: binaryen-ffi, binaryen-support, others)  
- [x] Create `rust/Cargo.toml` workspace (members: binaryen-ffi, binaryen-support, others)  
  See: [Getting Started](../vision/rust-conversion-getting-started.md)
- [ ] Add `cmake/BinaryenRust.cmake` and wire `BUILD_RUST_COMPONENTS` into top-level CMake  
- [x] Add `cmake/BinaryenRust.cmake` and wire `BUILD_RUST_COMPONENTS` into top-level CMake  
  See: [Phase 0: infrastructure setup](../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup)
- [ ] Add `rust/binaryen-ffi` crate with a minimal exported C API (extern "C")  
- [x] Add `rust/binaryen-ffi` crate with a minimal exported C API (extern "C")  
  See: [FFI patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- [ ] Configure `cbindgen` and generate a golden header committed to `include/`  
- [x] Configure `cbindgen` and generate a golden header committed to `include/`  
  - [x] Add `BINARYEN_FFI_ABI_VERSION` macro to `include/binaryen_ffi.h` and Rust `pub const` in `rust/binaryen-ffi/src/lib.rs`.
  See: [Checklists](../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup)
- [ ] Add CI:
- [x] Add CI:
  - `cargo test --all` job
  - `cbindgen` golden diff job
  - `cbindgen` golden diff job implemented as GitHub Action (`.github/workflows/rust-ci.yml`)
  - `cmake` + `cargo` integration job with `-DBUILD_RUST_COMPONENTS=ON`
  - `smoke-consumer` job linking a small C++ binary to Rust lib
- [ ] Create C++ shim templates in `src/` to route calls to Rust when toggle enabled
- [x] Create C++ shim templates in `src/` to route calls to Rust when toggle enabled
  - [x] Add `src/support/rust_shim_template.h` (template) and `src/support/strings_rust.*` example shim.
  - Added `src/support/rust_shim_template.h` as a simple example and `src/support/strings_rust.*` as a working example.
  - [x] Example C++ wrapper for hashing helper now supported via `BinaryenAhashBytes`.
- [x] Create C++ shim templates in `src/` to route calls to Rust when toggle enabled

### Next steps (Phase 0 completion)

1. Add a helper script to regenerate the `cbindgen` golden header locally (`scripts/update_cbindgen.sh`) — this helps contributors update the golden header intentionally.
2. Add a PR template that prompts authors to run `scripts/check_cbindgen.sh` and the `rust_ffi_smoke` test; provides a checklist for ABI changes.
3. Improve CI to cache Cargo artifacts and to gate `cbindgen` and the smoke consumer under a `BUILD_RUST_COMPONENTS=ON` job — *don't enable heavy CI until caching and owners are in place*.
  - We added caching keys for the `cargo` registry and `rust/target` to reduce job runtime and GitHub minutes.
  - The `cmake-integration` job now runs `ctest -R rust_ffi_smoke -V` after building the rust libs, which tightens the feedback loop for ABI and linkage regressions.
4. Add a small section to the docs describing how to re-enable the disabled GitHub Action(s) and recommended caching options.

5. Add a manual fuzz-run workflow to allow collaborators to run `cargo-fuzz` harnesses on demand: `fuzz/` contains `fuzz_targets` and `.github/workflows/rust-fuzz.yml` is configured for `workflow_dispatch` to avoid continuous heavy CI runs.

These steps add convenience for contributors and help automate the golden-header and ABI checks for Phase 0, while keeping CI toggled off until owners and caching are configured.
- [ ] Document the FFI contract & ABI gating process in `docs/rust/vision/rust-conversion-technical-specs.md` and add reviewer list
  - `rust-ci` GitHub Action added to run `cargo test`, `cargo clippy`, `cargo fmt` and `cbindgen` golden-check (see `.github/workflows/rust-ci.yml`).

## Example code snippets

Cargo workspace:
```toml
// filepath: rust/Cargo.toml
[workspace]
members = ["binaryen-ffi", "binaryen-support", "binaryen-core", "binaryen-passes"]
```

CMake helper (simple version):
```cmake
// filepath: cmake/BinaryenRust.cmake
# ...existing code...
function(build_rust_crate crate_name crate_path)
  execute_process(
    COMMAND cargo build --manifest-path ${crate_path}/Cargo.toml --release
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    RESULT_VARIABLE _cargo_result
  )
  if(NOT _cargo_result EQUAL 0)
    message(FATAL_ERROR "cargo build failed for ${crate_name}")
  endif()
  set(artifact "${CMAKE_SOURCE_DIR}/${crate_path}/target/release/lib${crate_name}.a")
  add_library(${crate_name} STATIC IMPORTED)
  set_target_properties(${crate_name} PROPERTIES IMPORTED_LOCATION ${artifact})
endfunction()
# ...existing code...
```

Sample `cbindgen` config:
```toml
// filepath: rust/binaryen-ffi/cbindgen.toml
language = "C"
parse.dependency = true
[clean]
write = true
```

CI golden header check (GitHub Action job snippet):
```yaml
# filepath: .github/workflows/rust-infra.yml
# ...existing code...
- name: Generate and check cbindgen header
  run: |
    (cd rust/binaryen-ffi && cbindgen --config cbindgen.toml --crate binaryen-ffi --output ../../include/binaryen_ffi.h)
    git --no-pager diff --exit-code -- include/binaryen_ffi.h || (echo "Header changed; check ABI and update golden file intentionally." && exit 1)
# ...existing code...
```

C++ shim template:
```cpp
// filepath: src/support/strings_rust.cpp
// ...existing code...
#ifdef BUILD_RUST_COMPONENTS
extern "C" {
  // generated by rust/binaryen-ffi
  void* binaryen_string_interner_new();
  void binaryen_string_interner_free(void*);
  const char* binaryen_string_intern(void*, const char*);
}
void* StringInterner::create() {
  return binaryen_string_interner_new();
}
#else
// existing C++ fallback
#endif
```

## Exit criteria
- `cmake` builds with `BUILD_RUST_COMPONENTS=ON` on CI (no baseline regression)
- `cbindgen` header is generated and matches golden file
- A smoke consumer binary can call minimal Rust API via generated header
- `cargo test --all` stable in CI

## Gating policy & ABIs
- Any changes to `#[repr(C)]` types or exported functions require ABI review and updating the golden header file with sign-off
- Label PRs that touch FFI as `rust-ffi`; require at least one Infra owner review
- Keep the default build behavior OFF (boolean toggle) until all core infra items are approved

## Collaboration and handoffs
- Provide simple crate templates and shims; keep APIs small and stable
- Publish `rust-infra` internal checklist: "add cbindgen config", "add golden header", "add shim template", "add smoke consumer"
- Add owners for `cbindgen` golden file and `cmake/BinaryenRust.cmake`

## References (deep links)
- Phase 0: [RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup](../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup)
- Getting started: [rust-conversion-getting-started.md](../vision/rust-conversion-getting-started.md)
- FFI patterns & arena: [rust-conversion-technical-specs.md#ffi-patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- Checklists: [rust-conversion-checklists.md#phase-0-infrastructure-setup](../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup)