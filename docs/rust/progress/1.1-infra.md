# Team Infra Plan â€” Phase 0 (Infrastructure & FFI)

Short summary:
- Goal: Make Rust components buildable, testable, and ABI-safe from the C++ CMake pipeline while preserving the C++ baseline.
- See the master plan and checklists in:
  - ../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup
  - ../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup
  - ../vision/rust-conversion-technical-specs.md#ffi-patterns

## Objectives
- Cargo workspace + skeleton crates
- CMake integration + BUILD_RUST_COMPONENTS toggle
- cbindgen header generation + golden-check
- CI jobs for Rust unit tests, integration build, and ABI checks
- Small C++ smoke consumer examples and shim templates for teams to use

## Tasks (priority order)
- [ ] Create `rust/Cargo.toml` workspace (members: binaryen-ffi, binaryen-support, others)  
  See: [Getting Started](../vision/rust-conversion-getting-started.md)
- [ ] Add `cmake/BinaryenRust.cmake` and wire `BUILD_RUST_COMPONENTS` into top-level CMake  
  See: [Phase 0: infrastructure setup](../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup)
- [ ] Add `rust/binaryen-ffi` crate with a minimal exported C API (extern "C")  
  See: [FFI patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- [ ] Configure `cbindgen` and generate a golden header committed to `include/`  
  See: [Checklists](../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup)
- [ ] Add CI:
  - `cargo test --all` job
  - `cbindgen` golden diff job
  - `cmake` + `cargo` integration job with `-DBUILD_RUST_COMPONENTS=ON`
  - `smoke-consumer` job linking a small C++ binary to Rust lib
- [ ] Create C++ shim templates in `src/` to route calls to Rust when toggle enabled
- [ ] Document the FFI contract & ABI gating process in `docs/rust/vision/rust-conversion-technical-specs.md` and add reviewer list

## Example code snippets

Cargo workspace:
```toml
// filepath: rust/Cargo.toml
[workspace]
members = ["binaryen-ffi", "binaryen-support", "binaryen-core", "binaryen-passes"]
```

CMake helper (simple version):
```cmake
// filepath: cmake/BinaryenRust.cmake
# ...existing code...
function(build_rust_crate crate_name crate_path)
  execute_process(
    COMMAND cargo build --manifest-path ${crate_path}/Cargo.toml --release
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    RESULT_VARIABLE _cargo_result
  )
  if(NOT _cargo_result EQUAL 0)
    message(FATAL_ERROR "cargo build failed for ${crate_name}")
  endif()
  set(artifact "${CMAKE_SOURCE_DIR}/${crate_path}/target/release/lib${crate_name}.a")
  add_library(${crate_name} STATIC IMPORTED)
  set_target_properties(${crate_name} PROPERTIES IMPORTED_LOCATION ${artifact})
endfunction()
# ...existing code...
```

Sample `cbindgen` config:
```toml
// filepath: rust/binaryen-ffi/cbindgen.toml
language = "C"
parse.dependency = true
[clean]
write = true
```

CI golden header check (GitHub Action job snippet):
```yaml
# filepath: .github/workflows/rust-infra.yml
# ...existing code...
- name: Generate and check cbindgen header
  run: |
    (cd rust/binaryen-ffi && cbindgen --config cbindgen.toml --crate binaryen-ffi --output ../../include/binaryen_ffi.h)
    git --no-pager diff --exit-code -- include/binaryen_ffi.h || (echo "Header changed; check ABI and update golden file intentionally." && exit 1)
# ...existing code...
```

C++ shim template:
```cpp
// filepath: src/support/strings_rust.cpp
// ...existing code...
#ifdef BUILD_RUST_COMPONENTS
extern "C" {
  // generated by rust/binaryen-ffi
  void* binaryen_string_interner_new();
  void binaryen_string_interner_free(void*);
  const char* binaryen_string_intern(void*, const char*);
}
void* StringInterner::create() {
  return binaryen_string_interner_new();
}
#else
// existing C++ fallback
#endif
```

## Exit criteria
- `cmake` builds with `BUILD_RUST_COMPONENTS=ON` on CI (no baseline regression)
- `cbindgen` header is generated and matches golden file
- A smoke consumer binary can call minimal Rust API via generated header
- `cargo test --all` stable in CI

## Gating policy & ABIs
- Any changes to `#[repr(C)]` types or exported functions require ABI review and updating the golden header file with sign-off
- Label PRs that touch FFI as `rust-ffi`; require at least one Infra owner review
- Keep the default build behavior OFF (boolean toggle) until all core infra items are approved

## Collaboration and handoffs
- Provide simple crate templates and shims; keep APIs small and stable
- Publish `rust-infra` internal checklist: "add cbindgen config", "add golden header", "add shim template", "add smoke consumer"
- Add owners for `cbindgen` golden file and `cmake/BinaryenRust.cmake`

## References (deep links)
- Phase 0: [RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup](../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup)
- Getting started: [rust-conversion-getting-started.md](../vision/rust-conversion-getting-started.md)
- FFI patterns & arena: [rust-conversion-technical-specs.md#ffi-patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- Checklists: [rust-conversion-checklists.md#phase-0-infrastructure-setup](../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup)