# Team Infra Plan — Phase 0 (Infrastructure & FFI)

Short summary:
- Goal: Make Rust components buildable, testable, and ABI-safe from the C++ CMake pipeline while preserving the C++ baseline.
- Phase 0 (Infrastructure & FFI) is implemented and validated locally and in CI for the core features listed below.
- See the master plan and checklists in:
  - ../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup
  - ../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup
  - ../vision/rust-conversion-technical-specs.md#ffi-patterns

## Objectives (Summary of Phase 0 achievements)
- Cargo workspace + skeleton crates
- CMake integration + BUILD_RUST_COMPONENTS toggle
- cbindgen header generation + golden-check
- CI jobs for Rust unit tests, integration build, and ABI checks
- Small C++ smoke consumer examples and shim templates for teams to use
Completed (high level):
- Cargo workspace (`rust/Cargo.toml`) with members for `binaryen-ffi`, `binaryen-support`, `binaryen-core`.
- `cmake/BinaryenRust.cmake` integrated in `CMakeLists.txt` and a `BUILD_RUST_COMPONENTS` toggle added.
- `cbindgen` configuration added in `rust/binaryen-ffi/cbindgen.toml`; golden header generated at `include/binaryen_ffi.h` and validated in CI.
- CI jobs added to run `cargo test`, `cbindgen` golden diff, and a CMake integration job that runs `ctest -R rust_ffi_smoke -V` under `BUILD_RUST_COMPONENTS=ON`.
- Small C++ smoke-consumer examples and a shim template (`src/support/rust_shim_template.h`) and example `src/support/strings_rust.*` are present and exercised in CI.

## Tasks (priority order)
- [x] Create `rust/Cargo.toml` workspace (members: binaryen-ffi, binaryen-support, others)  
  See: [Getting Started](../vision/rust-conversion-getting-started.md)
- [x] Add `cmake/BinaryenRust.cmake` and wire `BUILD_RUST_COMPONENTS` into top-level CMake  
  See: [Phase 0: infrastructure setup](../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup)
- [x] Add `rust/binaryen-ffi` crate with a minimal exported C API (extern "C")  
  See: [FFI patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- [x] Configure `cbindgen` and generate a golden header committed to `include/`  
  - [x] Add `BINARYEN_FFI_ABI_VERSION` macro to `include/binaryen_ffi.h` and Rust `pub const` in `rust/binaryen-ffi/src/lib.rs`.
  See: [Checklists](../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup)
 - [x] Add CI:
  - `cargo test --all` job
  - `cbindgen` golden diff job
  - `cbindgen` golden diff job implemented as GitHub Action (`.github/workflows/rust-ci.yml`)
  - `cmake` + `cargo` integration job with `-DBUILD_RUST_COMPONENTS=ON`
  - `smoke-consumer` job linking a small C++ binary to Rust lib (tested via `ctest -R rust_ffi_smoke -V`)
 
  - [x] Add `src/support/rust_shim_template.h` (template) and `src/support/strings_rust.*` example shim.
  - Added `src/support/rust_shim_template.h` as a simple example and `src/support/strings_rust.*` as a working example.
  - [x] Example C++ wrapper for hashing helper now supported via `BinaryenAhashBytes`.
- [x] Create C++ shim templates in `src/` to route calls to Rust when toggle enabled
  
  ## What we implemented and validated

  - cbindgen golden header and ABI versioning
    - `rust/binaryen-ffi` now exports `BINARYEN_FFI_ABI_VERSION` as a Rust `pub const` and `include/binaryen_ffi.h` contains the matching header macro.
    - `rust/scripts/check_cbindgen.sh` verifies the cbindgen-generated header matches the golden header; CI enforces this check.

  - FFI & CMake integration
    - `cmake/BinaryenRust.cmake` integrates Cargo builds into CMake, producing static importable targets used by the C++ build when `BUILD_RUST_COMPONENTS=ON`.
    - A smoke consumer (`test/rust_consumer`) compiles and runs in the CMake build when the toggle is enabled.

  - Rust workspace & libs
    - Support libraries implemented under `rust/binaryen-support`: `StringInterner`, `Arena`, `FastHashMap`/`ahash` helpers, benches and property tests.
    - `rust/binaryen-ffi` contains FFI wrappers for the utilities as well as ABI-safe helpers used by C++.
    - `rust/binaryen-core` contains the initial `Type` enum; `Signature` and `HeapType` remain in progress.

  - Scripts and tooling
    - Canonical scripts moved to `rust/scripts/` and include:
      - `rust/scripts/check_cbindgen.sh`
      - `rust/scripts/check_abi_changes.sh`
      - `rust/scripts/update_cbindgen.sh`
      - `rust/scripts/run_cargo_fuzz.sh`
      - `rust/scripts/run_bench.sh`
    - Root-level duplicates in `scripts/` were removed or replaced with small shims to avoid surprises; `rust/scripts/` is now canonical for Rust infra scripts.

  - Fuzzing
    - Fuzz harnesses added for `interner`, `arena`, `ahash`, and `fastmap` under `fuzz/` with short-run local validation. A `rust/scripts/run_cargo_fuzz.sh` helper exists and CI exposes a `workflow_dispatch` for manual runs (`.github/workflows/rust-fuzz.yml`).

  ## Next steps (Phase 0 closure items and Phase 1 prioritization)

  1. Stabilize and extended CI for Rust components
     - Add a nightly benchmark job and an artifact-based regression comparator for Criteria baselines (`.github/workflows/rust-bench-nightly.yml` placeholder present).
     - Expand Miri/ASAN/UBSAN coverage in CI for critical crates (partial coverage present; increase scope and run frequency).
  2. Expand FFI wrappers and ABI documentation
     - Add complete `Signature`/`HeapType`/`Type` FFI surface as they are stabilized.
     - Finalize ABI gating guidance in `docs/rust/vision` and add a PR checklist column for ABI owners (draft template and PR checklist exist).
  3. CI & cache improvements
     - Ensure Cargo artifact caching is used across CI jobs that exercise `BUILD_RUST_COMPONENTS` to keep runtime reasonable.
     - Tune `rust-ci` to gate heavy jobs and keep a low default cost for PRs.
  4. Fuzz & Bench schedule
     - Convert manual fuzz runs to scheduled short runs for critical harnesses. Keep `workflow_dispatch` for on-demand long runs or reproductions.
     - Monitor fastmap/other harnesses and upload corpora/artifacts for longer runs when needed. Consider a ClusterFuzz integration later.

  ## Exit criteria (revised)

  - Completed:
    - `cmake` builds with `BUILD_RUST_COMPONENTS=ON` under CI (no C++ baseline regressions), and the smoke consumer is validated in CI.
    - `cbindgen` golden header exists at `include/binaryen_ffi.h` and CI verifies it on PRs.
    - Rust libraries for Phase 1 (support libs) exist, have tests, benches, and short fuzzers.

  - Still open:
    - Full Type system (`Signature`, `HeapType`) and corresponding FFI wrappers (Phase 2) are in progress.
    - Bench regression comparator and more comprehensive Miri/ASAN/UBSAN coverage in CI.
    - Expand FFI wrapper coverage and add cross-language end-to-end tests for commonly used APIs.

## Outstanding Phase 0 tasks (recommended to close Phase 0 fully)

- [x] Finalize FFI contract and ABI gating process in `docs/rust/vision` and add a detailed reviewer list and sign-off steps (suggested PR gating checklist added; final owner list pending).
- [ ] Add or expand `CODEOWNERS` entries to require reviews from multiple maintainers for ABI or CMake changes (e.g., `/include/binaryen_ffi.h`, `/cmake/BinaryenRust.cmake`, `/rust/`) *(DISABLED — intentionally postponed; will not proceed with this change for now)*.

> NOTE: We are deliberately postponing expansion of `CODEOWNERS` to avoid repository-level gating for ABI changes until the team finalizes an agreed review process and a small set of owners; will revisit when that is decided.
 - [x] Implement a nightly Criterion benchmarks job that uploads artifacts (comparator TBD) — nightly job uploads artifacts; comparator logic is a follow-up item. This nightly bench run is scheduled (not PR-gated) and does not block PRs.
- [x] Expand `miri` and sanitizer coverage (ASAN/UBSAN) for critical crates and add scheduled checks in CI (Miri now runs for `binaryen-support` and `binaryen-core` at nightly schedule; sanitizer expansion is pending); these checks run on schedule or main-only and are not PR-gating by default.
- [x] Add a small set of cross-language C++ integration tests beyond the smoke consumer to better validate ownership and memory contracts across FFI boundaries (added `test_ffi_extra.c` and CI `ctest` test `rust_ffi_smoke_extra`). The extra test runs as part of the heavy CMake integration job, which is push/main-only and will not gate PRs.
- [x] Expand the `rust-fuzz.yml` workflow or add a short-scheduled fuzz job for critical harnesses, and add corpus upload and artifact retention rules for long-run reproductions (scheduled job now runs with longer short runs and artifact retention set).
- [ ] Add a CI step that builds `BUILD_RUST_COMPONENTS=ON` for a matrix of platforms and caches `rust/target` to accelerate PR workflows (we added `rust/target` caching for `cmake-integration`; matrix schedules are pending).
- [x] Make `rust/scripts` canonical by removing any remaining `scripts/` duplicates and ensure the PR template asks for the required checks to be run.

### Next steps (Phase 0 completion)

1. Add a helper script to regenerate the `cbindgen` golden header locally (`rust/scripts/update_cbindgen.sh`) — this helps contributors update the golden header intentionally.
2. Add a PR template that prompts authors to run `rust/scripts/check_cbindgen.sh` and the `rust_ffi_smoke` test; provides a checklist for ABI changes.
3. Improve CI to cache Cargo artifacts and to gate `cbindgen` and the smoke consumer under a `BUILD_RUST_COMPONENTS=ON` job — *don't enable heavy CI until caching and owners are in place*.
  - We added caching keys for the `cargo` registry and `rust/target` to reduce job runtime and GitHub minutes.
  - The `cmake-integration` job now runs `ctest -R rust_ffi_smoke -V` after building the rust libs, which tightens the feedback loop for ABI and linkage regressions.
4. Add a small section to the docs describing how to re-enable the disabled GitHub Action(s) and recommended caching options.

5. Add a manual fuzz-run workflow to allow collaborators to run `cargo-fuzz` harnesses on demand: `fuzz/` contains `fuzz_targets` and `.github/workflows/rust-fuzz.yml` is configured for `workflow_dispatch` to avoid continuous heavy CI runs.

These steps add convenience for contributors and help automate the golden-header and ABI checks for Phase 0, while keeping CI toggled off until owners and caching are configured.
- [ ] Document the FFI contract & ABI gating process in `docs/rust/vision/rust-conversion-technical-specs.md` and add reviewer list
  - `rust-ci` GitHub Action added to run `cargo test`, `cargo clippy`, `cargo fmt` and `cbindgen` golden-check (see `.github/workflows/rust-ci.yml`).

## Exit criteria (fully close Phase 0)

- [ ] ABI gating doc finalized and approved; PRs that change exported FFI must include changelog, `BINARYEN_FFI_ABI_VERSION` bump, and reviewer sign-off.
- [ ] Bench baselines and CI comparator active; nightly job detects regressions and alerts relevant reviewers.
- [ ] `miri` and sanitizer coverage expanded and passing for critical crates.
- [ ] Scheduled short fuzz runs for key harnesses enabled; corpus upload & retention policy exists for long runs.
- [x] At least one additional cross-language integration test beyond the smoke consumer is added and exercised under CI (see `test/rust_consumer/test_ffi_extra.c`).

## Example code snippets

Cargo workspace:
```toml
// filepath: rust/Cargo.toml
[workspace]
members = ["binaryen-ffi", "binaryen-support", "binaryen-core", "binaryen-passes"]
```

CMake helper (simple version):
```cmake
// filepath: cmake/BinaryenRust.cmake
# ...existing code...
function(build_rust_crate crate_name crate_path)
  execute_process(
    COMMAND cargo build --manifest-path ${crate_path}/Cargo.toml --release
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    RESULT_VARIABLE _cargo_result
  )
  if(NOT _cargo_result EQUAL 0)
    message(FATAL_ERROR "cargo build failed for ${crate_name}")
  endif()
  set(artifact "${CMAKE_SOURCE_DIR}/${crate_path}/target/release/lib${crate_name}.a")
  add_library(${crate_name} STATIC IMPORTED)
  set_target_properties(${crate_name} PROPERTIES IMPORTED_LOCATION ${artifact})
endfunction()
# ...existing code...
```

Sample `cbindgen` config:
```toml
// filepath: rust/binaryen-ffi/cbindgen.toml
language = "C"
parse.dependency = true
[clean]
write = true
```

CI golden header check (GitHub Action job snippet):
```yaml
# filepath: .github/workflows/rust-infra.yml
# ...existing code...
- name: Generate and check cbindgen header
  run: |
    (cd rust/binaryen-ffi && cbindgen --config cbindgen.toml --crate binaryen-ffi --output ../../include/binaryen_ffi.h)
    git --no-pager diff --exit-code -- include/binaryen_ffi.h || (echo "Header changed; check ABI and update golden file intentionally." && exit 1)
# ...existing code...
```

C++ shim template:
```cpp
// filepath: src/support/strings_rust.cpp
// ...existing code...
#ifdef BUILD_RUST_COMPONENTS
extern "C" {
  // generated by rust/binaryen-ffi
  void* binaryen_string_interner_new();
  void binaryen_string_interner_free(void*);
  const char* binaryen_string_intern(void*, const char*);
}
void* StringInterner::create() {
  return binaryen_string_interner_new();
}
#else
// existing C++ fallback
#endif
```

## Exit criteria
- `cmake` builds with `BUILD_RUST_COMPONENTS=ON` on CI (no baseline regression)
- `cbindgen` header is generated and matches golden file
- A smoke consumer binary can call minimal Rust API via generated header
- `cargo test --all` stable in CI

## Gating policy & ABIs
- Any changes to `#[repr(C)]` types or exported functions require ABI review and updating the golden header file with sign-off
- Label PRs that touch FFI as `rust-ffi`; require at least one Infra owner review
- Keep the default build behavior OFF (boolean toggle) until all core infra items are approved

## Collaboration and handoffs
- Provide simple crate templates and shims; keep APIs small and stable
- Publish `rust-infra` internal checklist: "add cbindgen config", "add golden header", "add shim template", "add smoke consumer"
- Add owners for `cbindgen` golden file and `cmake/BinaryenRust.cmake`

## References (deep links)
- Phase 0: [RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup](../vision/RUST_CONVERSION_PLAN.md#phase-0-infrastructure-setup)
- Getting started: [rust-conversion-getting-started.md](../vision/rust-conversion-getting-started.md)
- FFI patterns & arena: [rust-conversion-technical-specs.md#ffi-patterns](../vision/rust-conversion-technical-specs.md#ffi-patterns)
- Checklists: [rust-conversion-checklists.md#phase-0-infrastructure-setup](../vision/rust-conversion-checklists.md#phase-0-infrastructure-setup)